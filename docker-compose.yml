services:
  speaches:
    container_name: speaches
    build:
      dockerfile: Dockerfile.rocm
      context: .
    restart: unless-stopped
    ports:
      - 8000:8000
    develop:
      watch:
        - action: rebuild
          path: ./uv.lock
        - action: sync+restart
          path: ./src
          target: /app/src
    environment:
      - HSA_OVERRIDE_GFX_VERSION=10.3.0
      - TORCH_ROCM_AOTRITON_ENABLE_EXPERIMENTAL=1
      - MIOPEN_LOG_LEVEL=3
      - WHISPER_MODEL=Systran/faster-whisper-large-v3
      - KOKORO_MODEL=speaches-ai/Kokoro-82M-v1.0-ONNX
      - DEVICE=rocm
      - COMPUTE_TYPE=float16
      - BATCH_SIZE=8
      - BEAM_SIZE=5
      - PYTHONUNBUFFERED=1
    devices:
      - "/dev/kfd:/dev/kfd"
      - "/dev/dri:/dev/dri"
    cap_add:
      - SYS_PTRACE
    shm_size: 8gb
    volumes:
      - hf-hub-cache:/home/speaches/.cache/huggingface/hub
      - ./model_aliases.json:/app/model_aliases.json:ro
      - speaches-models:/app/models
    env_file:
      - path: .env
        required: false
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import requests; requests.get('http://localhost:8000/health', timeout=5)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  hf-hub-cache:
  speaches-models:
